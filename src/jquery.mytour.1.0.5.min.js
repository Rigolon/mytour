/**
 * MyTour - jQuery plugin to create an easy virtual tour across any website.  
 * Copyright (c) 2012, Rogério Taques. 
 *
 * Licensed under MIT license:
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this 
 * software and associated documentation files (the "Software"), to deal in the Software 
 * without restriction, including without limitation the rights to use, copy, modify, merge, 
 * publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons 
 * to whom the Software is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or 
 * substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING 
 * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND 
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * @requires jQuery v1.2 or above
 * @version 1.0
 * @cat Plugins/UI 
 * @author Rogério Taques (rogerio@awin.com.br | http://awin.com.br)
 * @see http://code.google.com/p/jquery-mytour/
 */

(function($){var version='1.0.5',stepContainer=[],stepCurrent=0,tourTrigger=null,defaults={start:0,buttons:{next:'Next',prev:'Prev',start:'Start',finish:'Finish',menu:true},autoPlay:false,timer:5000,steps:'#my-tour-steps',stepHolder:'li',onStart:null,onShow:null,beforePlay:null,afterPlay:null,onFinish:null,debug:false},methods={version:function(){return this.each(function(){$(this).html(version);});},init:function(options){var o=$.extend(defaults,options);return this.each(function(){var t=$(this),s=$(o.steps+' > '+o.stepHolder),tip=$('<div />',{id:"my-tour-tooltip",class:"my-tour-tooltip"}),overlay=$('<div />',{id:"my-tour-overlay",class:"my-tour-overlay"}),shield=$('<div />',{id:"my-tour-shield",class:"my-tour-shield"});s.hide();for(var i=0;i<s.length;i++){if($($(s[i]).data('id')).length){stepContainer[stepContainer.length]=$(s[i]).clone();}$(s[i]).remove();}$('body').append(overlay.hide()).append(shield.hide()).append(tip.hide());tip.append($('<div />',{id:"my-tour-content"})).append($('<span/>',{id:"my-tour-tooltip-nub",class:"my-tour-tooltip-nub"})).append($('<div />',{id:"my-tour-button-bar"}));stepCurrent=parseInt((o.start||0),10);if(stepCurrent>stepContainer.length||stepCurrent<0)stepCurrent=0;t.click(function(e){e.preventDefault();tourTrigger=t;if(o.onShow&&'function'==typeof(o.onShow)){o.onShow();}_play(o);});if(o.onStart&&'function'==typeof(o.onStart)){o.onStart();}if(o.autoPlay){if(o.onShow&&'function'==typeof(o.onShow)){o.onShow();}_autoplay(o);}});}};function _autoplay(options){if(stepCurrent<stepContainer.length-1){setTimeout(function(){stepCurrent++;_autoplay(options);},options.timer);}_play(options);}function _stop(options){stepCurrent=0;$('#my-tour-tooltip').fadeOut('fast');$('#my-tour-overlay, #my-tour-shield').fadeOut('fast');$('.my-tour-highlight').removeClass('my-tour-highlight');centerWindow=Math.ceil($(window).height()/2);triggerOffset=Math.ceil(tourTrigger.offset().top-centerWindow);$("html, body").animate({scrollTop:triggerOffset},'fast');if(options.onFinish&&'function'==typeof(options.onFinish)){options.onFinish();}};function _isFixed(obj){if($(obj).css('position')=='fixed')return true;if(!$(obj).parent().is('body'))return _isFixed($(obj).parent());return false;}function _play(options){var o=options,tip=$(stepContainer[stepCurrent]),tipPos=null,nub=null,el=null,elPos=null,elPosIndex=['bottom','top','right','left','none'],me=$('#my-tour-tooltip'),tipOffset=null,centerWindow=null,mytop=0,myleft=0,overlay=$('#my-tour-overlay, #my-tour-shield');$('.my-tour-highlight').removeClass('my-tour-highlight');if(o.beforePlay&&'function'==typeof(o.beforePlay)){o.beforePlay(stepCurrent);}if(o.debug){console.log('Current Step: '+(stepCurrent)+' Steps Defined: '+stepContainer.length);}if(tip.length){el=$(tip.data('id'));if(el.length){overlay.fadeIn('fast');me.fadeOut('fast',function(){me.find('#my-tour-content').empty().append(tip.html());me.find('#my-tour-button-bar').remove();me.append(_button(o));tipPos=(tip.data('position')||'bottom');elPos=el.offset();nub=me.find('#my-tour-tooltip-nub');if(tipPos=='none'){mytop=($(window).height()/2)-(me.outerHeight()/2);myleft=($(window).width()/2)-(me.outerWidth()/2);}else if(tipPos=='top'||tipPos=='bottom'){mytop=(tipPos=='top'?(elPos.top-me.outerHeight()-(nub.outerHeight()/2)):(elPos.top+el.outerHeight()-(nub.outerHeight()/2)+parseInt(el.css('margin-bottom'),10)));if(tipPos=='top'&&(mytop-me.outerHeight())<0){mytop=(elPos.top+el.outerHeight()+(nub.outerHeight()/2)-parseInt(el.css('margin-bottom'),10));tipPos='bottom';}else if(tipPos=='bottom'&&mytop+me.outerHeight()>$(window).height()){mytop=(elPos.top-me.outerHeight()-(nub.outerHeight()/2));tipPos='top';}}else if(tipPos=='left'||tipPos=='right'){myleft=(tipPos=='left'?elPos.left-(nub.outerWidth()/2)-me.outerWidth():elPos.left+el.outerWidth()+(nub.outerWidth()/2));if(tipPos=='left'&&myleft<0){myleft=elPos.left+el.outerWidth()+nub.outerWidth();tipPos='right';}else if(tipPos=='right'&&myleft+me.outerWidth()>$(window).width()){myleft=elPos.left-nub.outerWidth()-me.outerWidth();tipPos='left';}}nub.removeAttr('style');nub.removeClass('top bottom left right none');nub.addClass(tipPos);switch(elPosIndex.indexOf(tipPos)){case 1:me.css({display:'block',top:mytop-10,left:elPos.left+(el.outerWidth()/2)-(me.outerWidth()/2)}).animate({'top':'+=10'},150);nub.css({left:Math.ceil(me.outerWidth()/2)});break;case 2:me.css({display:'block',top:(elPos.top-(me.outerHeight()/2)+(el.outerHeight()/2)),left:myleft+10}).animate({'left':'-=10'},150);nub.css({top:Math.ceil((me.outerHeight()/2)-(nub.outerHeight()/2))});break;case 3:me.css({display:'block',top:(elPos.top-Math.ceil(me.outerHeight()/2)),left:myleft-10}).animate({'left':'+=10'},150);nub.css({top:Math.ceil(me.outerHeight()/2),left:me.outerWidth()});break;case 4:me.css({display:'block',top:mytop-10,left:myleft}).animate({'top':'+=10'},150);break;default:me.css({display:'block',top:mytop+10,left:elPos.left+(el.outerWidth()/2)-(me.outerWidth()/2)}).animate({'top':'-=10'},150);nub.css({left:Math.ceil((me.outerWidth()/2)-(nub.outerWidth()/2))});break;}if(tipPos=='top'||tipPos=='bottom'){var diff=Math.ceil(me.offset().left+me.outerWidth()-$(window).width());if(diff>0){me.css({left:me.offset().left-diff});nub.css({left:diff+parseInt(nub.css('left'),10)});}}if(!_isFixed(el)){centerWindow=Math.ceil($(window).height()/2);tipOffset=Math.ceil(me.offset().top-centerWindow);$("html, body").animate({scrollTop:tipOffset},'slow');}if(tipPos!='none'){el.addClass('my-tour-highlight');}me.fadeIn('fast');});}else
{stepCurrent+=1;_play(o);}}if(o.afterPlay&&'function'==typeof(o.afterPlay)){o.afterPlay(stepCurrent);}};function _button(options){var o=options,prev=$('<a href="#"  id="my-tour-button-prev"></a>'),next=$('<a href="#"  id="my-tour-button-next"></a>'),start=$('<a href="#"  id="my-tour-button-start"></a>'),finish=$('<a href="#"  id="my-tour-button-finish"></a>'),steps=$('<select id="my-tour-dropdown-steps" ></select>'),div=$('<div id="my-tour-button-bar" ></div>');if(!o.autoPlay&&o.buttons.start){if(stepCurrent>0){start.click(function(e){e.preventDefault();stepCurrent=0;_play(o);});}else
{start.click(function(e){e.preventDefault();}).addClass('disabled');}start.html(o.buttons.start).appendTo(div);}if(!o.autoPlay&&o.buttons.prev){if(stepCurrent>0){prev.click(function(e){e.preventDefault();stepCurrent-=1;_play(o);});}else
{prev.click(function(e){e.preventDefault();}).addClass('disabled');}prev.html(o.buttons.prev).appendTo(div);}if(!o.autoPlay&&o.buttons.next){if(stepCurrent<stepContainer.length-1){next.click(function(e){e.preventDefault();stepCurrent+=1;_play(o);});}else
{next.click(function(e){e.preventDefault();}).addClass('disabled');}next.html(o.buttons.next).appendTo(div);}if((!o.autoPlay&&o.buttons.finish)||(o.buttons.finish&&stepCurrent>=stepContainer.length-1)){finish.click(function(e){e.preventDefault();stepCurrent=0;_stop(o);});finish.html(o.buttons.finish).appendTo(div);}if(!o.autoPlay&&o.buttons.menu){var i=0,j=i+1;for(i=0;i<stepContainer.length;i++){if($(stepContainer[i].data('id')).length){steps.append('<option value="'+(i)+'" '+(stepCurrent==i?'selected="selected"':'')+' >'+(j++)+'</option>');}}steps.change(function(){stepCurrent=parseInt(this.value,10);_play(o);}).appendTo(div);}return div;};$.fn.mytour=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else
{$.error('Method '+method+' does not exist on jQuery.mytour()');}};})(jQuery);